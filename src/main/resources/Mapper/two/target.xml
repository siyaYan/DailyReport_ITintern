<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.dailyReport.Mapper.two.target">

    <resultMap id="attendTable" type="com.example.dailyReport.Bean.Attend">
        <!--column 字段 property 必须一致-->
        <!--<id column="attend_id" javaType="INTEGER"/>-->
        <result column="school_id" property="school_id" jdbcType="INTEGER"/>
        <result column="class_id" property="class_id" jdbcType="INTEGER"/>
        <result column="person_id" property="person_id" jdbcType="INTEGER"/>
        <result column="person_name" property="person_name" jdbcType="VARCHAR"/>
        <!-- <result column="position" property="position" jdbcType="VARCHAR"/>-->
        <result column="attend_status" property="attend_status" jdbcType="INTEGER"/>
        <result column="attend_time" property="attend_time" jdbcType="INTEGER"/>
    </resultMap>

    <resultMap id="abnormalClass" type="com.example.dailyReport.Bean.AttendAbnormal">
        <result column="class_name" property="class_name" jdbcType="VARCHAR"/>
        <result column="stage" property="stage" jdbcType="INTEGER"/>
        <result column="class_no" property="leave_sum" jdbcType="INTEGER"/>
    </resultMap>

    <select id="selectTypeSum" resultType="INTEGER">
            select count(*) from attend  where school_id=#{school_id} and class_id = #{class_id} and attend_status =#{type}
            and attend_time &gt;= ${date} and attend_time &lt; ${date}+86400
    </select>

    <select id="selectAbnormalClassId" resultType="INTEGER">
        select DISTINCT class_id from attend where school_id=#{school_id}  and attend_status !=0
            and attend_time &gt;= ${date} and attend_time &lt; ${date}+86400
    </select>

    <select id="selectAbnormalClass"   resultMap="abnormalClass">
            select class_name, stage,class_no
            from class where school_id=#{school_id}  and class_id = #{class_id}
    </select>

    <insert id="insertAttends"  useGeneratedKeys="true" keyColumn="attend_id" parameterType="java.util.List" >
        insert into attend(
        school_id,
        class_id,
        person_id,
        person_name,
        attend_status,
        attend_time)
        values
        <foreach collection="list" item="item" index="index" separator=",">
        (        #{item.school_id},#{
                item.class_id},#{
                item.person_id},#{
                item.person_name},#{
                item.attend_status},#{
                item.attend_time}
        )
        </foreach>
    </insert>

    <insert id="insertAttend"  useGeneratedKeys="true" keyColumn="attend_id" parameterType="com.example.dailyReport.Bean.Attend" >
        insert into attend
        (school_id,
         class_id,
         person_id,
         person_name,
         attend_status,
         attend_time)
        values
        (
            #{school_id},#{
            class_id},#{
            person_id},#{
            person_name},#{
            attend_status},#{
            attend_time}
        )
    </insert>

    <select id="selectClassIdByName" resultType="INTEGER">
        select class_id from class where class_name = #{param1} and stage = #{param2}
    </select>

    <select id="selectClassIdByPerson" resultType="INTEGER" parameterType="INTEGER">
        select class_id from person_class_relation where person_id = #{person_id}
    </select>

    <select id="selectPersonId" resultType="INTEGER" parameterType="java.lang.String">
        select person_id from person where third_no = #{student_no}
    </select>

    <select id="personNum" resultType="INTEGER" >
        select count(*) from person where school_id=#{school_id}  and person_type = #{type}
    </select>

    <select id="abnormalNum" resultType="INTEGER" >
        select count(*) from attend where school_id=#{school_id} and attend_status!=0
        and attend_time &gt;= #{date} and attend_time &lt; ${date}+86400
    </select>

    <!--Order by attend_time desc-->
    <select id="selectRecentAttend" resultMap="attendTable">
        select
            school_id,
             class_id,
             person_id,
             person_name,
             attend_status,
             attend_time
        from attend where school_id=#{school_id}
        and attend_time &gt;= #{date} and attend_time &lt; ${date}+86400
        order by attend_time desc
    </select>

    <select id="selectDayConsume" resultType="INTEGER">
        select
            amount
        from consume where school_id=#{school_id} and type=#{type}
                      and consume_time &gt;= #{date} and consume_time &lt; ${date}+86400
    </select>

    <select id="selectConsumePlaces" resultType="java.lang.String">
    select  DISTINCT
            position
        from consume where school_id=#{school_id} and type=1
                       and consume_time &gt;= #{date} and consume_time &lt; ${date}+86400
    </select>

    <select id="countConsumePlace" resultType="INTEGER">
        select count(*)
        from consume where school_id=#{school_id} and type=1 and position=#{position}
        and consume_time &gt;= #{date} and consume_time &lt; ${date}+86400
    </select>

</mapper>